name: CD
on:
  push:
    branches:
      - main
      - feature/*
jobs:
  
  api-gateway:
    runs-on: ubuntu-latest
    needs: [user-service]
    steps:
      - name: ğŸš›Checkout code
        uses: actions/checkout@v2

      - name: ğŸ¦Setup var
        id: vars
        run: echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"

      - name: ğŸš€Log in to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ›¸Publish to Registry
        uses: docker/build-push-action@v2
        with:
          context: api_gateway/
          push: true
          tags: michaellazebny/wtc_system.api_gateway:${{ steps.vars.outputs.sha_short }}

      - name: ğŸ’Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: ğŸ·Save DigitalOcean kubeconfig with short-lived credentials
        run: doctl kubernetes cluster kubeconfig save --expiry-seconds 600 k8s-wtc

      - name: ğŸ‹ï¸Deploy
        run: |
          helm --debug upgrade --install \
          -f api_gateway/.helm/values-dev.yaml \
          --set image.tag=${{ steps.vars.outputs.sha_short }}, redis.password=${{ secrets.REDIS_PASSWORD }},jwt.secret=${{ secrets.JWT_SECRET }} api-gateway api_gateway/.helm

  user-service:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš›Checkout code
        uses: actions/checkout@v2

      - name: ğŸ¦Setup var
        id: vars
        run: echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"

      - name: ğŸš€Log in to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ›¸Publish to Registry
        uses: docker/build-push-action@v2
        with:
          context: user_service/
          push: true
          tags: michaellazebny/wtc_system.user_service:${{ steps.vars.outputs.sha_short }}

      - name: ğŸ’Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: ğŸ·Save DigitalOcean kubeconfig with short-lived credentials
        run: doctl kubernetes cluster kubeconfig save --expiry-seconds 600 k8s-wtc

      - name: ğŸ‹ï¸Deploy
        run: |
          helm --debug upgrade --install \
          -f user_service/.helm/values-dev.yaml \
          --set image.tag=${{ steps.vars.outputs.sha_short }} \
          user-service user_service/.helm
