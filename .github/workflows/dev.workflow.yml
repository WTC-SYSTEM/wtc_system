name: CD
on:
  push:
    branches:
      - main
      - feature/*
  pull_request:
jobs:
  
  api-gateway:
    runs-on: ubuntu-latest
    needs: [ user-service ]
    steps:
      - name: 🚛Building and pushing to the dockerhub
        uses: WTC-SYSTEM/wtc_system/.github/workflows/reusable-build.workflow.yml@main
        with:
          service_name: api_gateway
          context: api_gateway/
          secrets: inherit

      - name: 💎Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: 🍷Save DigitalOcean kubeconfig with short-lived credentials
        run: doctl kubernetes cluster kubeconfig save --expiry-seconds 600 k8s-wtc

      - name: 🏋️Deploy
        run: |
          helm upgrade --install api-gateway -f api_gateway/.helm/values-dev.yaml \
          --set image.tag="${{ steps.vars.outputs.sha_short }}",redis.pswrd="${{ secrets.REDIS_PASSWORD }}" \
          --set jwt.secret=${{ secrets.JWT_SECRET }} api_gateway/.helm

  user-service:
    runs-on: ubuntu-latest
    steps:
      - uses: ./.github/workflows/reusable-build.workflow.yml@main
        with:
          service_name: user_service
          context: user_service/
          secrets: inherit

      - name: 💎Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: 🍷Save DigitalOcean kubeconfig with short-lived credentials
        run: doctl kubernetes cluster kubeconfig save --expiry-seconds 600 k8s-wtc

      - name: 🏋️Deploy
        run: |
          helm --debug upgrade --install \
          -f user_service/.helm/values-dev.yaml \
          --set image.tag=${{ steps.vars.outputs.sha_short }} \
          user-service user_service/.helm
