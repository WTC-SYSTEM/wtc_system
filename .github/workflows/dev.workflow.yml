name: CD
on:
  push:
    branches:
      - main
      - feature/*
  pull_request:
jobs:
  
  api-gateway-build:
    uses: ./.github/workflows/reusable_build.workflow.yml
    with:
      service_name: api_gateway
      context: api_gateway/
    secrets: inherit

  api-gateway-deploy:
    uses: ./.github/workflows/reusable_deploy.workflow.yml
    needs:
      - api-gateway-build
    with:
      service_name: api_gateway
      tag: ${{ needs.api-gateway-build.outputs.tag }}
    secrets: inherit


  user-service-build:
    uses: ./.github/workflows/reusable_build.workflow.yml
    with:
      service_name: user_service
      context: user_service/
    secrets: inherit
#    steps:
#      - name: ğŸš›Building and pushing to the dockerhub
#
#
#      - name: ğŸ’Install doctl
#        uses: digitalocean/action-doctl@v2
#        with:
#          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
#
#      - name: ğŸ·Save DigitalOcean kubeconfig with short-lived credentials
#        run: doctl kubernetes cluster kubeconfig save --expiry-seconds 600 k8s-wtc
#
#      - name: ğŸ‹ï¸Deploy
#        run: |
#          helm --debug upgrade --install \
#          -f user_service/.helm/values-dev.yaml \
#          --set image.tag=${{ steps.vars.outputs.sha_short }} \
#          user-service user_service/.helm
