name: CD
on:
  push:
    branches: [ main ]

jobs:

  check:
    runs-on: ubuntu-20.04
    outputs:
      user_service: ${{ steps.check_files.outputs.user_service }}
    steps:
      - name: ðŸš›Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 2

      - name: ðŸ‚check modified files
        id: check_files
        run: |
          echo "=============== list modified files ==============="
          git diff --name-only HEAD^ HEAD
          echo "========== check paths of modified files =========="
          git diff --name-only HEAD^ HEAD > files.txt
          while IFS= read -r file; do
            echo $file
            if [[ $file == user_service/* ]]; then
              echo "::set-output name=user_service::true"
            elif  [[ $file == api_gateway/* ]]; then
              echo "::set-output name=api_gateway::true"
            else
              echo "file does not belong to any service"
            fi
          done < files.txt

  api-gateway:
    runs-on: ubuntu-latest
    needs: [ check ]
    if: needs.check.outputs.api_gateway == 'true'
    steps:
      - name: ðŸš›Checkout code
        uses: actions/checkout@v2

      - name: ðŸ¦Setup var
        id: vars
        run: echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"

      - name: ðŸš€Log in to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ›¸Publish to Registry
        uses: docker/build-push-action@v2
        with:
          context: api_gateway/
          push: true
          tags: michaellazebny/wtc_system.api_gateway:${{ steps.vars.outputs.sha_short }}

      - name: ðŸ’ŽInstall doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: ðŸ·Save DigitalOcean kubeconfig with short-lived credentials
        run: doctl kubernetes cluster kubeconfig save --expiry-seconds 600 k8s-wtc

      - name: ðŸ‹ï¸Deploy
        run: |
          helm --debug upgrade --install \
          -f api_gateway/.helm/values-dev.yaml \
          --set image.tag=${{ steps.vars.outputs.sha_short }} \
          api-gateway api_gateway/.helm

  user-service:
    runs-on: ubuntu-latest
    needs: [ check ]
    if: needs.check.outputs.user_service == 'true'
    steps:
      - name: ðŸš›Checkout code
        uses: actions/checkout@v2

      - name: ðŸ¦Setup var
        id: vars
        run: echo "::set-output name=sha_short::$(git rev-parse --short HEAD)"

      - name: ðŸš€Log in to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ðŸ›¸Publish to Registry
        uses: docker/build-push-action@v2
        with:
          context: user_service/
          push: true
          tags: michaellazebny/wtc_system.user_service:${{ steps.vars.outputs.sha_short }}

      - name: ðŸ’ŽInstall doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: ðŸ·Save DigitalOcean kubeconfig with short-lived credentials
        run: doctl kubernetes cluster kubeconfig save --expiry-seconds 600 k8s-wtc

      - name: ðŸ‹ï¸Deploy
        run: |
          helm --debug upgrade --install \
          -f user_service/.helm/values-dev.yaml \
          --set image.tag=${{ steps.vars.outputs.sha_short }} \
          user-service user_service/.helm
